/*! happy_chess 2014-06-26 */
(function(){var a,b,c,d,e,f={}.hasOwnProperty,g=function(a,b){return function(){return a.apply(b,arguments)}};e=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),window.Game={},Game.columns=9,Game.rows=10,Game.margin_top=50,Game.margin_left=50,Game.piece_padding=60,Game.radius=26,Game.is_debug=!0,Game.log=function(a){if(""===$("#debug").val()){if(Game.is_debug)return $("#debug").val(a)}else if(Game.is_debug)return $("#debug").val($("#debug").val()+"\n"+a)},b=function(){function a(a,b){this.name_symbol=a,this.name=this.name_symbol.indexOf("_")>-1?this.name_symbol.split("_")[0]:this.name_symbol,this.is_alive=!0,this.is_selected=!1,this.is_hover=!1,this.color=b,this.point=new c(this.start_point().x,this.start_point().y),this.target_point=null}return a.reverse_point=function(a){return{x:8-a.x,y:9-a.y}},a.prototype.set_point=function(a){return this.point=a},a.prototype.move_to_point=function(a){this.target_point=c.clone(a),a=null},a.prototype.update=function(){this.target_point&&(this.target_point.x!==this.point.x&&(this.target_point.x<this.point.x&&(this.point.x-=1),this.target_point.x>this.point.x&&(this.point.x+=1)),this.target_point.y!==this.point.y&&(this.target_point.y<this.point.y&&(this.point.y-=1),this.target_point.y>this.point.y&&(this.point.y+=1)))},a.prototype.renderTo=function(a){a.beginPath(),a.arc(this.point.x_in_world(),this.point.y_in_world(),Game.radius,0,2*Math.PI,!1),a.fillStyle=this.color,a.fill(),a.lineWidth=5,a.strokeStyle=this.is_selected?"#FF9900":this.is_hover?"#BDBDBD":"#003300",a.stroke(),a.font="20pt Calibri",a.fillStyle="#FFF",a.textAlign="center",a.fillText(this.label(),this.point.x_in_world(),this.point.y_in_world()+10)},a.prototype.label=function(){var a;return a=null,"carriage"===this.name&&(a="red"===this.color?"车":"車"),"horse"===this.name&&(a="red"===this.color?"马":"馬"),"elephant"===this.name&&(a="red"===this.color?"象":"相"),"knight"===this.name&&(a="red"===this.color?"士":"士"),"chief"===this.name&&(a="red"===this.color?"将":"帅"),"gun"===this.name&&(a="red"===this.color?"炮":"炮"),"soldier"===this.name&&(a="red"===this.color?"兵":"卒"),a},a.prototype.start_point=function(){switch(this.name_symbol){case"carriage_l":return"red"===this.color?{x:0,y:0}:a.reverse_point({x:0,y:0});case"carriage_r":return"red"===this.color?{x:8,y:0}:a.reverse_point({x:8,y:0});case"horse_l":return"red"===this.color?{x:1,y:0}:a.reverse_point({x:1,y:0});case"horse_r":return"red"===this.color?{x:7,y:0}:a.reverse_point({x:7,y:0});case"elephant_l":return"red"===this.color?{x:2,y:0}:a.reverse_point({x:2,y:0});case"elephant_r":return"red"===this.color?{x:6,y:0}:a.reverse_point({x:6,y:0});case"knight_l":return"red"===this.color?{x:3,y:0}:a.reverse_point({x:3,y:0});case"knight_r":return"red"===this.color?{x:5,y:0}:a.reverse_point({x:5,y:0});case"chief":return"red"===this.color?{x:4,y:0}:a.reverse_point({x:4,y:0});case"gun_l":return"red"===this.color?{x:1,y:2}:a.reverse_point({x:1,y:2});case"gun_r":return"red"===this.color?{x:7,y:2}:a.reverse_point({x:7,y:2});case"soldier_1":return"red"===this.color?{x:0,y:3}:a.reverse_point({x:0,y:3});case"soldier_2":return"red"===this.color?{x:2,y:3}:a.reverse_point({x:2,y:3});case"soldier_3":return"red"===this.color?{x:4,y:3}:a.reverse_point({x:4,y:3});case"soldier_4":return"red"===this.color?{x:6,y:3}:a.reverse_point({x:6,y:3});case"soldier_5":return"red"===this.color?{x:8,y:3}:a.reverse_point({x:8,y:3})}},a.prototype.moveable_points=function(){var a,b,d,e,f;switch(a=[],this.name){case"carriage":for(b=e=0;8>=e;b=++e)b!==this.point.x&&a.push(new c(b,this.point.y));for(d=f=0;9>=f;d=++f)d!==this.point.y&&a.push(new c(this.point.x,d));break;case"horse":this.point.x+1<=8&&this.point.y+2<=9&&a.push(new c(this.point.x+1,this.point.y+2)),this.point.x+2<=8&&this.point.y+1<=9&&a.push(new c(this.point.x+2,this.point.y+1)),this.point.x+2<=8&&this.point.y-1>=0&&a.push(new c(this.point.x+2,this.point.y-1)),this.point.x+1<=8&&this.point.y-2>=0&&a.push(new c(this.point.x+1,this.point.y-2)),this.point.x-1>=0&&this.point.y-2>=0&&a.push(new c(this.point.x-1,this.point.y-2)),this.point.x-2>=0&&this.point.y-1>=0&&a.push(new c(this.point.x-2,this.point.y-1)),this.point.x-2>=0&&this.point.y+1<=9&&a.push(new c(this.point.x-2,this.point.y+1)),this.point.x-1>=0&&this.point.y+2<=9&&a.push(new c(this.point.x-1,this.point.y+2));break;case"elephant":this.point.x-2>=0&&this.point.y-2>=0&&a.push(new c(this.point.x-2,this.point.y-2)),this.point.x-2>=0&&this.point.y+2<=4&&a.push(new c(this.point.x-2,this.point.y+2)),this.point.x+2<=8&&this.point.y+2<=4&&a.push(new c(this.point.x+2,this.point.y+2)),this.point.x+2<=8&&this.point.y-2>=0&&a.push(new c(this.point.x+2,this.point.y-2));break;case"knight":this.point.is_at(3,0)?a.push(new c(4,1)):this.point.is_at(3,2)?a.push(new c(4,1)):this.point.is_at(5,2)?a.push(new c(4,1)):this.point.is_at(5,0)?a.push(new c(4,1)):this.point.is_at(4,1)&&(a.push(new c(3,0)),a.push(new c(3,2)),a.push(new c(5,2)),a.push(new c(5,0)));break;case"chief":this.point.x-1>=3&&this.point.y-1>=0&&a.push(new c(this.point.x-1,this.point.y-1)),this.point.x-1>=3&&this.point.y+1<=2&&a.push(new c(this.point.x-1,this.point.y+1)),this.point.x+1<=5&&this.point.y+1<=2&&a.push(new c(this.point.x+1,this.point.y+1)),this.point.x+1<=5&&this.point.y-1>=0&&a.push(new c(this.point.x+1,this.point.y-1));break;case"gun":break;case"soldier":this.point.y<=4?a.push(new c(this.point.x,this.point.y+1)):(this.point.x-1>=0&&a.push(new c(this.point.x-1,this.point.y)),this.point.x+1<=8&&a.push(new c(this.point.x+1,this.point.y)),this.point.y+1<=9&&a.push(new c(this.point.x,this.point.y+1)))}return a},a.prototype.active=function(){return this.is_selected=!0},a.prototype.deactive=function(){return this.is_selected=!1},a.prototype.hover=function(){return this.is_hover=!0},a.prototype.hout=function(){return this.is_hover=!1},a}(),c=function(){function a(a,b){this.x=a,this.y=b,this.is_hover=!1,this.moveable=!1,this.state=null}return a.clone=function(b){return new a(b.x,b.y)},a.prototype.x_in_world=function(){return this.x*Game.piece_padding+Game.margin_left},a.prototype.y_in_world=function(){return(Game.rows-1-this.y)*Game.piece_padding+Game.margin_top},a.prototype.is_at=function(a,b){return this.x===a&&this.y===b},a.prototype.is_same=function(a){return this.x===a.x&&this.y===a.y},a.prototype.hover=function(){return this.is_hover=!0},a.prototype.hout=function(){return this.is_hover=!1},a.prototype.mark_moveable=function(){return this.moveable=!0},a.prototype.reset_moveable=function(){return this.moveable=!1},a.prototype.renderTo=function(a){return this.is_hover&&(a.beginPath(),a.arc(this.x_in_world(),this.y_in_world(),4,0,2*Math.PI,!1),a.lineWidth=5,a.strokeStyle="#003300",a.stroke()),this.moveable?(a.beginPath(),a.arc(this.x_in_world(),this.y_in_world(),4,0,2*Math.PI,!1),a.lineWidth=5,a.strokeStyle="#FF9900",a.stroke()):void 0},a.prototype.is_in=function(a){var b,c,d,e;for(b=!1,d=0,e=a.length;e>d;d++)if(c=a[d],this.is_same(c))return b=!0;return b},a.prototype.is_at_top_edge=function(){return 9===this.y},a.prototype.is_at_bottom=function(){return 0===this.y},a.prototype.is_at_left_edge=function(){return 0===this.x},a.prototype.is_at_right_edge=function(){return this.x===Game.columns-1},a.prototype.is_at_self_river=function(){return 4===this.y},a.prototype.is_at_enmy_river=function(){return 5===this.y},a.prototype.toPosition=function(){return{x:this.x*Game.piece_padding,y:(Game.rows-1-this.y)*Game.piece_padding}},a.prototype.toPositionInWorld=function(){return{x:this.x*Game.piece_padding+Game.margin_left,y:(Game.rows-1-this.y)*Game.piece_padding+Game.margin_top}},a}(),d=function(){function a(a,b){null==b&&(b=""),this.color=a,"red"===this.color?this.name="红方"+b:"black"===this.color&&(this.name="黑方"+b),this.pieces={carriage_l:null,carriage_r:null,horse_l:null,horse_r:null,elephant_l:null,elephant_r:null,knight_l:null,knight_r:null,chief:null,gun_l:null,gun_r:null,soldier_1:null,soldier_2:null,soldier_3:null,soldier_4:null,soldier_5:null}}return a.prototype.alive_pieces=function(){return this.pieces_array(!1)},a.prototype.pieces_array=function(a){var b,c,d,e;if(null==a&&(a=!0),a){if(this.piece_array_ignore_alive)return this.piece_array_ignore_alive;this.piece_array_ignore_alive=[],d=this.pieces;for(b in d)f.call(d,b)&&(c=d[b],this.piece_array_ignore_alive.push(c));return this.piece_array_ignore_alive}this.piece_array_alive=[],e=this.pieces;for(b in e)f.call(e,b)&&(c=e[b],c.is_alive&&this.piece_array_alive.push(c));return this.piece_array_alive},a.prototype.spawn_pieces=function(){return this.pieces.carriage_l=new b("carriage_l",this.color),this.pieces.carriage_r=new b("carriage_r",this.color),this.pieces.horse_l=new b("horse_l",this.color),this.pieces.horse_r=new b("horse_r",this.color),this.pieces.elephant_l=new b("elephant_l",this.color),this.pieces.elephant_r=new b("elephant_r",this.color),this.pieces.knight_l=new b("knight_l",this.color),this.pieces.knight_r=new b("knight_r",this.color),this.pieces.chief=new b("chief",this.color),this.pieces.gun_l=new b("gun_l",this.color),this.pieces.gun_r=new b("gun_r",this.color),this.pieces.soldier_1=new b("soldier_1",this.color),this.pieces.soldier_2=new b("soldier_2",this.color),this.pieces.soldier_3=new b("soldier_3",this.color),this.pieces.soldier_4=new b("soldier_4",this.color),this.pieces.soldier_5=new b("soldier_5",this.color),this.pieces_array()},a}(),window.Player=d,a=function(){function a(a){null==a&&(a="chess_game"),this.main=g(this.main,this),this.lastTime=Date.now(),this.canvas_element=document.getElementById(a),this.canvasElemLeft=this.canvas_element.offsetLeft,this.canvasElemTop=this.canvas_element.offsetTop,this.ctx=this.canvas_element.getContext("2d"),this.ctx_width=this.canvas_element.width,this.ctx_height=this.canvas_element.height,this.margin_top=Game.margin_top,this.margin_left=Game.margin_left,this.piece_margin=Game.piece_padding,this.columns=Game.columns,this.rows=Game.rows,this.panel_width=(this.columns-1)*this.piece_margin,this.panel_height=(this.rows-1)*this.piece_margin,this.points=[],this.pieces=[],this.player_red=null,this.player_black=null,this.current_player=null,this.current_points=[],this.selected_piece=null,this.target_point=null,Game.log("panel width: "+this.panel_width+", height: "+this.panel_height)}return a.prototype.main=function(){var a,b;b=Date.now(),a=(b-this.lastTime)/1e3,this.update(a),this.render(),this.lastTime=b,e(this.main)},a.prototype.update=function(a){var b,c,d,e;for(this.current_points=[],e=this.pieces,c=0,d=e.length;d>c;c++)b=e[c],this.current_points.push(b.point),this.selected_piece===b&&this.target_point&&(this.selected_piece.move_to_point(this.target_point),this.selected_piece.update(a))},a.prototype.render=function(){var a,b,c,d,e,f,g,h,i,j,k;for(this.ctx.fillStyle="#FFF",this.ctx.fillRect(0,0,this.ctx_width,this.ctx_height),this.canvas_element.width=1,this.canvas_element.width=this.ctx_width,this.drawMap(),j=this.points,d=0,g=j.length;g>d;d++)for(c=j[d],e=0,h=c.length;h>e;e++)b=c[e],b.renderTo(this.ctx);for(k=this.pieces,f=0,i=k.length;i>f;f++)a=k[f],a.renderTo(this.ctx)},a.prototype.is_blank_point=function(a){var b,c,d,e,f;for(b=!0,f=this.pieces,d=0,e=f.length;e>d;d++)if(c=f[d],c.point.is_same(a))return b=!1;return b},a.prototype.point=function(a,b){return this.points[a][b]},a.prototype.fill_points=function(){var a,b,d,e,f,g,h,i,j,k,l;for(a=function(){k=[];for(var a=0,b=this.columns-1;b>=0?b>=a:a>=b;b>=0?a++:a--)k.push(a);return k}.apply(this),b=function(){l=[];for(var a=0,b=this.rows-1;b>=0?b>=a:a>=b;b>=0?a++:a--)l.push(a);return l}.apply(this),g=0,i=b.length;i>g;g++)for(e=b[g],h=0,j=a.length;j>h;h++)d=a[h],(f=this.points)[d]||(f[d]=[]),this.points[d].push(new c(d,e))},a.prototype.init=function(){this.fill_points(),this.setupPlayers(),this.setupPieces(),this.setupEventListener(),this.main(),Game.is_debug||$("#debug_panel").hide()},a.prototype.drawMap=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;for(c=this.point(0,0),f=this.point(8,0),e=this.point(0,9),h=this.point(8,9),this.ctx.beginPath(),this.ctx.strokeStyle="#000000",this.ctx.lineWidth=4,this.ctx.moveTo(c.x_in_world(),c.y_in_world()),this.ctx.lineTo(e.x_in_world(),e.y_in_world()),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e.x_in_world(),e.y_in_world()),this.ctx.lineTo(h.x_in_world(),h.y_in_world()),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(h.x_in_world(),h.y_in_world()),this.ctx.lineTo(f.x_in_world(),f.y_in_world()),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(f.x_in_world(),f.y_in_world()),this.ctx.lineTo(c.x_in_world(),c.y_in_world()),this.ctx.stroke(),this.ctx.strokeStyle="#BDBDBD",this.ctx.lineWidth=1,u=v=1;8>=v;u=++v)d=this.point(0,u),g=this.point(8,u),this.ctx.beginPath(),this.ctx.moveTo(d.x_in_world(),d.y_in_world()),this.ctx.lineTo(g.x_in_world(),g.y_in_world()),this.ctx.stroke();for(s=w=1;7>=w;s=++w)b=this.point(s,0),r=this.point(s,4),this.ctx.beginPath(),this.ctx.moveTo(b.x_in_world(),b.y_in_world()),this.ctx.lineTo(r.x_in_world(),r.y_in_world()),this.ctx.stroke();for(t=x=1;7>=x;t=++x)a=this.point(t,5),q=this.point(t,9),this.ctx.beginPath(),this.ctx.moveTo(a.x_in_world(),a.y_in_world()),this.ctx.lineTo(q.x_in_world(),q.y_in_world()),this.ctx.stroke();j=this.point(3,0),i=this.point(5,2),this.ctx.beginPath(),this.ctx.moveTo(j.x_in_world(),j.y_in_world()),this.ctx.lineTo(i.x_in_world(),i.y_in_world()),this.ctx.stroke(),l=this.point(5,0),k=this.point(3,2),this.ctx.beginPath(),this.ctx.moveTo(l.x_in_world(),l.y_in_world()),this.ctx.lineTo(k.x_in_world(),k.y_in_world()),this.ctx.stroke(),n=this.point(3,7),m=this.point(5,9),this.ctx.beginPath(),this.ctx.moveTo(n.x_in_world(),n.y_in_world()),this.ctx.lineTo(m.x_in_world(),m.y_in_world()),this.ctx.stroke(),p=this.point(5,7),o=this.point(3,9),this.ctx.beginPath(),this.ctx.moveTo(p.x_in_world(),p.y_in_world()),this.ctx.lineTo(o.x_in_world(),o.y_in_world()),this.ctx.stroke()},a.prototype.setupPlayers=function(){this.player_red=new d("red"),this.player_black=new d("black"),this.current_player=this.player_red},a.prototype.setupPieces=function(){this.pieces.push.apply(this.pieces,this.player_red.spawn_pieces()),this.pieces.push.apply(this.pieces,this.player_black.spawn_pieces()),Game.log("Piece count: "+this.pieces.length)},a.prototype.setupEventListener=function(){this.canvas_element.addEventListener("mousemove",function(a){return function(b){var c,d,e,f,g,h,i,j,k,l,m,n;for(f=b.pageX-a.canvasElemLeft,g=b.pageY-a.canvasElemTop,l=a.pieces,h=0,j=l.length;j>h;h++)c=l[h],f>=c.point.x_in_world()-Game.radius&&f<=c.point.x_in_world()+Game.radius&&g>=c.point.y_in_world()-Game.radius&&g<=c.point.y_in_world()+Game.radius?c.hover():c.hout();for(m=a.points,n=[],i=0,k=m.length;k>i;i++)e=m[i],n.push(function(){var a,b,c;for(c=[],a=0,b=e.length;b>a;a++)d=e[a],c.push(f>=d.x_in_world()-Game.radius&&f<=d.x_in_world()+Game.radius&&g>=d.y_in_world()-Game.radius&&g<=d.y_in_world()+Game.radius?this.is_blank_point(d)?d.hover():void 0:d.hout());return c}.call(a));return n}}(this)),this.canvas_element.addEventListener("click",function(a){return function(b){var d,e,f,g,h,i,j,k,l,m,n,o;for(g=b.pageX-a.canvasElemLeft,h=b.pageY-a.canvasElemTop,console.log("receive click event on canvas: ",g,h),m=a.current_player.alive_pieces(),i=0,k=m.length;k>i;i++)d=m[i],g>=d.point.x_in_world()-Game.radius&&g<=d.point.x_in_world()+Game.radius&&h>=d.point.y_in_world()-Game.radius&&h<=d.point.y_in_world()+Game.radius?(d.active(),a.selected_piece=d,a.mark_available_target_points(),Game.log("selected piece:"+a.selected_piece.name+", x,y:"+a.selected_piece.point.x+","+a.selected_piece.point.y)):d.deactive();for(n=a.points,o=[],j=0,l=n.length;l>j;j++)f=n[j],o.push(function(){var a,b,d;for(d=[],a=0,b=f.length;b>a;a++)if(e=f[a],g>=e.x_in_world()-Game.radius&&g<=e.x_in_world()+Game.radius&&h>=e.y_in_world()-Game.radius&&h<=e.y_in_world()+Game.radius){if(this.is_blank_point(e)){Game.log("Point ("+e.x+","+e.y+") is blank."),this.target_point=c.clone(e),this.reset_moveable_points();break}d.push(void 0)}else d.push(void 0);return d}.call(a));return o}}(this))},a.prototype.reset_moveable_points=function(){var a,b,c,d,e,f,g;for(g=this.points,c=0,e=g.length;e>c;c++)for(b=g[c],d=0,f=b.length;f>d;d++)a=b[d],a.reset_moveable()},a.prototype.mark_available_target_points=function(){var a,b,c,d,e,f,g,h;for(a=this.selected_piece.moveable_points(),Game.log("moveable points:"+a.length),h=this.points,d=0,f=h.length;f>d;d++)for(c=h[d],e=0,g=c.length;g>e;e++)b=c[e],b.is_in(a)?b.mark_moveable():b.reset_moveable()},a}(),$(function(){var b;return b=new a,window.t=b,b.init()})}).call(this);